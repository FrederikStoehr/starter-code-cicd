#V29
# https://docs.github.com/en/actions/concepts/runners/github-hosted-runners
# https://github.com/marketplace/actions/checkout
# https://github.com/actions/runner-images/blob/main/images/ubuntu/Ubuntu2404-Readme.md
# https://github.com/marketplace/actions/setup-node-js-environment
# https://github.com/marketplace/actions/cache
# https://github.com/marketplace/actions/deploy-github-pages-site
# https://github.com/marketplace/actions/upload-github-pages-artifact
name: Deploy To GH Pages
on:
  push:
    branches:
      - main
      - "feature/**"
    paths-ignore:
      - README.md
      - ".github/workflows/*"
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v5
      - name: Setup node and install dependencies
        uses: ./.github/actions/setupnode
        with:
          node-version: "20"
      - name: Run tests
        run: npm test

  build:
    needs:
      - test
    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v5
      - name: Setup node and install dependencies
        uses: ./.github/actions/setupnode
      - name: Build
        run: npm run build
      - name: Upload dist artifact
        uses: actions/upload-pages-artifact@v3 # or specific "vX.X.X" version tag for this action
        with:
          name: github-pages
          path: dist

  deploy:
    needs:
      - build
    runs-on: ubuntu-latest
    permissions:
      pages: write # to deploy to Pages
      id-token: write # to verify the deployment originates from an appropriate source

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
